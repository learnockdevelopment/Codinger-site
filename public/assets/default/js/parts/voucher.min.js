$(document).ready(function () {
    console.log('Document is ready');

    $('body').on('click', '#checkVoucher', function (e) {
        console.log('Voucher validation button clicked');
        e.preventDefault();

        var $this = $(this);
        console.log('Button reference:', $this);

        var voucherInput = $('#voucher_code_input');
        console.log('Voucher input reference:', voucherInput);

        var invalidFeedback = voucherInput.siblings('.invalid-feedback');
        console.log('Invalid feedback element:', invalidFeedback);

        var voucher = voucherInput.val();
        console.log('Voucher code entered:', voucher);

        // Reset validation classes and messages
        voucherInput.removeClass('is-invalid is-valid');
        invalidFeedback.addClass('d-none');

        if (voucher) {
            console.log('Voucher code is not empty, proceeding with validation');
            $this.addClass('loadingbar primary').prop('disabled', true);
            console.log('Button disabled and loading bar added');

            $.ajax({
                url: '/cart/voucher/validate',
                type: 'POST',
                data: {
                    voucher_code: voucher,
                    _token: '{{ csrf_token() }}'
                },
                success: function (result) {
                    console.log('AJAX success:', result);

                    if (result && result.valid) {
                        console.log('Voucher is valid, updating UI');
                        $('#totalAmount').text(result.amount); // Update total amount if needed
                        voucherInput.addClass('is-valid');
                        $('#checkVoucher').prop('disabled', true);
                    } else {
                        console.log('Voucher is invalid:', result.message);
                        voucherInput.addClass('is-invalid');
                        invalidFeedback.text(result.message).removeClass('d-none');
                    }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX error:', error);
                    voucherInput.addClass('is-invalid');
                    invalidFeedback.text("An error occurred while validating the voucher.").removeClass('d-none');
                },
                complete: function () {
                    console.log('AJAX request completed');
                    $this.removeClass('loadingbar primary').prop('disabled', false);
                }
            });
        } else {
            console.log('Voucher code is empty');
            voucherInput.addClass('is-invalid');
            invalidFeedback.removeClass('d-none');
        }
    });
});
